<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Referrals - Aruna Talent</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%23F4B4C6'/><text x='50' y='68' font-family='Arial' font-size='45' font-weight='bold' fill='white' text-anchor='middle'>A</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 50%, #fbcfe8 100%);
            min-height: 100vh; color: #1f2937;
        }
        .container { max-width: 1100px; margin: 0 auto; padding: 48px 20px; }

        /* Access Gate */
        .access-gate {
            display: flex; align-items: center; justify-content: center;
            min-height: 80vh; text-align: center;
        }
        .access-box {
            background: white; border-radius: 24px; padding: 48px;
            box-shadow: 0 4px 20px rgba(244, 180, 198, 0.25); max-width: 400px; width: 100%;
        }
        .access-box .logo { width: 120px; margin-bottom: 24px; }
        .access-box h1 { font-size: 24px; font-weight: 700; margin-bottom: 8px; }
        .access-box p { color: #6b7280; font-size: 14px; margin-bottom: 24px; }
        .access-input {
            width: 100%; padding: 14px 18px; border: 2px solid #e5e7eb; border-radius: 12px;
            font-size: 16px; text-align: center; letter-spacing: 2px; font-weight: 600;
            margin-bottom: 16px; transition: border-color 0.2s;
        }
        .access-input:focus { outline: none; border-color: #ec4899; }
        .access-btn {
            width: 100%; padding: 14px; background: linear-gradient(135deg, #ec4899 0%, #be185d 100%);
            color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600;
            cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
        }
        .access-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(236, 72, 153, 0.4); }
        .access-error { color: #ef4444; font-size: 13px; margin-top: 12px; display: none; }

        /* Dashboard */
        .dashboard { display: none; }
        .dashboard.active { display: block; }

        .header { text-align: center; margin-bottom: 40px; }
        .logo { width: 140px; margin-bottom: 24px; }
        .header h1 {
            font-size: 28px; font-weight: 800; margin-bottom: 8px;
            background: linear-gradient(135deg, #ec4899 0%, #be185d 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .header p { color: #6b7280; font-size: 15px; }

        /* Profile Card */
        .profile-card {
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
            border-radius: 24px; padding: 32px; color: white; margin-bottom: 32px;
        }
        .profile-header { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; }
        .profile-avatar {
            width: 72px; height: 72px; border-radius: 50%;
            background: linear-gradient(135deg, #f9a8d4 0%, #ec4899 100%);
            display: flex; align-items: center; justify-content: center;
            font-size: 32px; font-weight: 700;
        }
        .profile-name { font-size: 28px; font-weight: 800; }
        .profile-meta { display: flex; align-items: center; gap: 12px; margin-top: 6px; flex-wrap: wrap; }
        .profile-tier-badge {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 700;
        }
        .tier-base { background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); }
        .tier-gold { background: linear-gradient(135deg, #fbbf24 0%, #d97706 100%); color: #1f2937; }
        .tier-diamond { background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%); }
        .profile-joined { font-size: 13px; color: #9ca3af; }

        /* Tier Progress */
        .tier-progress { margin-bottom: 24px; }
        .tier-progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .tier-progress-label { font-size: 12px; color: #9ca3af; }
        .tier-progress-value { font-size: 12px; color: #f9a8d4; font-weight: 600; }
        .tier-progress-bar { height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; }
        .tier-progress-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
        .progress-to-gold { background: linear-gradient(90deg, #fbbf24, #d97706); }
        .progress-to-diamond { background: linear-gradient(90deg, #60a5fa, #3b82f6); }

        .profile-stats { display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; }
        .profile-stat {
            background: rgba(255,255,255,0.1); border-radius: 16px; padding: 16px; text-align: center;
        }
        .profile-stat.highlight { background: linear-gradient(135deg, rgba(236,72,153,0.3) 0%, rgba(190,24,93,0.3) 100%); border: 1px solid rgba(236,72,153,0.3); }
        .profile-stat-value { font-size: 18px; font-weight: 800; color: #f9a8d4; }
        .profile-stat-label { font-size: 9px; color: #d1d5db; margin-top: 4px; text-transform: uppercase; letter-spacing: 0.5px; }

        /* Models Table */
        .models-section {
            background: white; border-radius: 20px; overflow: hidden;
            box-shadow: 0 4px 20px rgba(244, 180, 198, 0.2); margin-bottom: 32px;
        }
        .models-header {
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
            padding: 20px 24px; color: white;
            display: flex; justify-content: space-between; align-items: center;
        }
        .models-title { font-size: 18px; font-weight: 700; }
        .models-count {
            background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 20px;
            font-size: 13px; font-weight: 600;
        }
        .models-table-header {
            display: grid; grid-template-columns: 1fr 100px 130px 130px 70px 130px;
            padding: 14px 24px; font-size: 11px; font-weight: 600; color: #9ca3af;
            text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #e5e7eb;
            background: #f9fafb;
        }
        .model-row {
            border-bottom: 1px solid #f3f4f6;
        }
        .model-row:last-child { border-bottom: none; }
        .model-row-main {
            display: grid; grid-template-columns: 1fr 100px 130px 130px 70px 130px;
            padding: 16px 24px; align-items: center;
            cursor: pointer; transition: background 0.2s;
        }
        .model-row-main:hover { background: #fdf2f8; }
        .model-row.expanded .model-row-main { background: #fdf2f8; }
        .model-info { display: flex; align-items: center; gap: 12px; }
        .model-avatar {
            width: 40px; height: 40px; border-radius: 50%;
            background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%);
            display: flex; align-items: center; justify-content: center; font-size: 16px;
        }
        .model-name { font-weight: 600; font-size: 14px; }
        .model-status { font-size: 11px; }
        .status-active { color: #10b981; }
        .status-inactive { color: #ef4444; }
        .status-new { color: #f59e0b; }
        .model-cell { font-size: 13px; color: #374151; text-align: center; }
        .model-cell.earnings { color: #ec4899; font-weight: 700; }
        .model-cell.revenue { font-weight: 600; }
        .model-cell.date { font-size: 12px; color: #6b7280; }
        .expand-icon {
            color: #9ca3af; font-size: 12px; margin-left: 8px;
            transition: transform 0.2s;
        }
        .model-row.expanded .expand-icon { transform: rotate(180deg); }

        /* Monthly Breakdown */
        .monthly-breakdown {
            display: none; background: #f9fafb; padding: 20px 24px;
            border-top: 1px solid #e5e7eb;
        }
        .model-row.expanded .monthly-breakdown { display: block; }
        .breakdown-title { font-size: 13px; font-weight: 600; color: #6b7280; margin-bottom: 12px; }
        .breakdown-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;
        }
        .breakdown-item {
            background: white; border-radius: 10px; padding: 12px;
            border: 1px solid #e5e7eb;
        }
        .breakdown-month { font-size: 12px; color: #6b7280; margin-bottom: 4px; }
        .breakdown-values { display: flex; justify-content: space-between; align-items: baseline; gap: 8px; flex-wrap: wrap; }
        .breakdown-revenue { font-size: 14px; font-weight: 700; color: #374151; }
        .breakdown-earning { font-size: 12px; color: #ec4899; font-weight: 600; }

        /* Summary Row */
        .summary-row {
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
            padding: 20px 24px; border-top: 2px solid #f9a8d4;
            display: grid; grid-template-columns: repeat(3, 1fr); align-items: center;
        }
        .summary-label { font-size: 14px; font-weight: 700; color: white; }
        .summary-item { text-align: center; }
        .summary-item-label { font-size: 11px; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.5px; }
        .summary-item-value { font-size: 24px; font-weight: 800; color: #f9a8d4; margin-top: 4px; }

        /* Commission Note */
        .commission-note {
            background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%);
            border-radius: 12px; padding: 16px; margin: 16px 24px 24px; text-align: center;
            font-size: 13px; color: #6b7280;
        }
        .commission-note strong { color: #be185d; }

        .footer { text-align: center; margin-top: 40px; color: #9ca3af; font-size: 13px; }
        .footer a { color: #ec4899; text-decoration: none; }

        .share-links-btn {
            display: inline-flex; align-items: center; gap: 8px;
            padding: 12px 20px; background: linear-gradient(135deg, #ec4899 0%, #be185d 100%);
            color: white; border-radius: 12px; font-size: 14px; font-weight: 600;
            text-decoration: none; transition: all 0.2s ease; white-space: nowrap;
        }
        .share-links-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(236, 72, 153, 0.4); }

        /* Quick Stats Banner */
        .quick-stats-banner {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 32px;
        }
        .quick-stat-card {
            background: white; border-radius: 16px; padding: 20px; text-align: center;
            box-shadow: 0 4px 20px rgba(244, 180, 198, 0.2);
        }
        .quick-stat-icon { font-size: 24px; margin-bottom: 8px; }
        .quick-stat-value { font-size: 20px; font-weight: 700; color: #1f2937; }
        .quick-stat-label { font-size: 12px; color: #6b7280; margin-top: 4px; }
        .quick-stat-change { font-size: 11px; margin-top: 4px; }
        .change-positive { color: #10b981; }
        .change-neutral { color: #6b7280; }

        @media (max-width: 900px) {
            .profile-stats { grid-template-columns: repeat(3, 1fr); }
            .profile-meta { flex-direction: column; align-items: flex-start; gap: 8px; }
            .models-table-header, .model-row-main {
                grid-template-columns: 1fr 90px 100px;
            }
            .models-table-header > *:nth-child(4),
            .models-table-header > *:nth-child(5),
            .models-table-header > *:nth-child(6),
            .model-row-main > *:nth-child(4),
            .model-row-main > *:nth-child(5),
            .model-row-main > *:nth-child(6) { display: none; }
            .breakdown-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 600px) {
            .container { padding: 24px 16px; }
            .profile-stats { grid-template-columns: repeat(2, 1fr); }
            .profile-header { flex-direction: column; text-align: center; }
            .access-box { padding: 32px 24px; margin: 0 16px; }
            .breakdown-grid { grid-template-columns: 1fr; }
            .summary-row { grid-template-columns: 1fr; gap: 16px; text-align: center; }
            .summary-label { text-align: center; }
        }
    </style>
</head>
<body>
    <!-- Access Gate -->
    <div class="access-gate" id="accessGate">
        <div class="access-box">
            <img src="logo.png" alt="Aruna Talent" class="logo">
            <h1>Referrer Portal</h1>
            <p>Enter your unique access code to view your referrals and earnings</p>
            <input type="text" class="access-input" id="accessCode" placeholder="ABC123" maxlength="10" autocomplete="off">
            <button class="access-btn" onclick="checkAccess()">Access My Dashboard</button>
            <p class="access-error" id="accessError">Invalid access code. Please try again.</p>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <div class="container">
            <div class="header">
                <img src="logo.png" alt="Aruna Talent" class="logo">
                <h1>My Referrals</h1>
                <p>Track your models and earnings in real-time</p>
            </div>

            <!-- Profile Card -->
            <div class="profile-card">
                <div class="profile-header">
                    <div class="profile-avatar" id="profileInitial">S</div>
                    <div style="flex: 1;">
                        <div class="profile-name" id="profileName">Sarah M.</div>
                        <div class="profile-meta">
                            <span class="profile-tier-badge tier-gold" id="profileTierBadge">‚≠ê Gold ¬∑ 2.75%</span>
                            <span class="profile-joined" id="profileJoined">Partner since Apr 2025</span>
                        </div>
                    </div>
                    <a href="referral-link.html" id="shareLinksBtn" class="share-links-btn">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg>
                        Share Links
                    </a>
                </div>
                <div class="tier-progress" id="tierProgress">
                    <div class="tier-progress-header">
                        <span class="tier-progress-label">Progress to Diamond Tier</span>
                        <span class="tier-progress-value" id="tierProgressText">$518K / $2M monthly</span>
                    </div>
                    <div class="tier-progress-bar">
                        <div class="tier-progress-fill progress-to-diamond" id="tierProgressFill" style="width: 26%;"></div>
                    </div>
                </div>
                <div class="profile-stats">
                    <div class="profile-stat">
                        <div class="profile-stat-value" id="statActiveModels">0</div>
                        <div class="profile-stat-label">Active</div>
                    </div>
                    <div class="profile-stat">
                        <div class="profile-stat-value" id="statInactiveModels">0</div>
                        <div class="profile-stat-label">Inactive</div>
                    </div>
                    <div class="profile-stat">
                        <div class="profile-stat-value" id="statAvgRetention">0 mo</div>
                        <div class="profile-stat-label">Avg Retention</div>
                    </div>
                    <div class="profile-stat">
                        <div class="profile-stat-value" id="statMonthlyRevenue">$0</div>
                        <div class="profile-stat-label">This Month Rev</div>
                    </div>
                    <div class="profile-stat highlight">
                        <div class="profile-stat-value" id="statMonthlyEarnings">$0</div>
                        <div class="profile-stat-label">This Month Earned</div>
                    </div>
                    <div class="profile-stat highlight">
                        <div class="profile-stat-value" id="statTotalEarnings">$0</div>
                        <div class="profile-stat-label">Total Earned</div>
                    </div>
                </div>
            </div>

            <!-- Active Models -->
            <div class="models-section">
                <div class="models-header">
                    <div class="models-title">Active Models</div>
                    <div class="models-count" id="activeCount">0 models</div>
                </div>
                <div class="models-table-header">
                    <div>Model</div>
                    <div style="text-align: center;">Started</div>
                    <div style="text-align: center;">This Month</div>
                    <div style="text-align: center;">Total Rev</div>
                    <div style="text-align: center;">Rate</div>
                    <div style="text-align: center;">Total Earned</div>
                </div>
                <div id="activeModelsBody">
                    <!-- Populated by JS -->
                </div>
                <div class="commission-note">
                    <strong>5%</strong> for each model's first 3 months, then <strong>your tier rate</strong> lifetime<br>
                    <span style="font-size: 12px;">Click any row to see monthly breakdown</span>
                </div>
            </div>

            <!-- Inactive Models -->
            <div class="models-section" id="inactiveSection" style="display: none;">
                <div class="models-header" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);">
                    <div class="models-title">Inactive Models</div>
                    <div class="models-count" id="inactiveCount">0 models</div>
                </div>
                <div class="models-table-header">
                    <div>Model</div>
                    <div style="text-align: center;">Started</div>
                    <div style="text-align: center;">Last Active</div>
                    <div style="text-align: center;">Total Rev</div>
                    <div style="text-align: center;">Months</div>
                    <div style="text-align: center;">Total Earned</div>
                </div>
                <div id="inactiveModelsBody">
                    <!-- Populated by JS -->
                </div>
            </div>

            <div class="footer">
                <p><a href="leaderboard.html">View Leaderboard</a> ¬∑ <a href="referral-link.html">Get Your Links</a> ¬∑ <a href="index.html">Refer More Creators</a></p>
                <p style="margin-top: 8px;">Questions? Contact your account manager</p>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // GOOGLE SHEETS CONFIGURATION
        // Replace these URLs with your published Google Sheets CSV URLs
        // ============================================
        const SHEETS_CONFIG = {
            // Set to true to use Google Sheets, false to use demo data
            useGoogleSheets: false,
            // Your published Google Sheets CSV URLs:
            referrersUrl: 'https://docs.google.com/spreadsheets/d/e/YOUR_SHEET_ID/pub?gid=0&single=true&output=csv',
            modelsUrl: 'https://docs.google.com/spreadsheets/d/e/YOUR_SHEET_ID/pub?gid=YOUR_MODELS_GID&single=true&output=csv'
        };

        // Demo data (used when useGoogleSheets is false)
        const DEMO_DATA = {
            'SARAH123': {
                name: 'Sarah M.',
                joinDate: '2025-04-01',
                models: [
                    { name: 'Emma T.', emoji: 'üå∏', startDate: '2026-01-15', status: 'active', monthlyRevenue: [{ month: 'Jan 2026', revenue: 147823.45 }] },
                    { name: 'Mia R.', emoji: 'ü¶ã', startDate: '2025-11-01', status: 'active', monthlyRevenue: [{ month: 'Nov 2025', revenue: 71489.32 }, { month: 'Dec 2025', revenue: 88752.18 }, { month: 'Jan 2026', revenue: 96341.67 }] },
                    { name: 'Ava L.', emoji: 'üå∫', startDate: '2025-09-20', status: 'active', monthlyRevenue: [{ month: 'Sep 2025', revenue: 43287.91 }, { month: 'Oct 2025', revenue: 79134.56 }, { month: 'Nov 2025', revenue: 94521.83 }, { month: 'Dec 2025', revenue: 107689.24 }, { month: 'Jan 2026', revenue: 113478.92 }] },
                    { name: 'Sophia K.', emoji: 'üí´', startDate: '2025-08-05', status: 'active', monthlyRevenue: [{ month: 'Aug 2025', revenue: 31456.78 }, { month: 'Sep 2025', revenue: 52891.34 }, { month: 'Oct 2025', revenue: 68234.19 }, { month: 'Nov 2025', revenue: 77845.62 }, { month: 'Dec 2025', revenue: 83129.47 }, { month: 'Jan 2026', revenue: 86573.21 }] },
                    { name: 'Olivia M.', emoji: '‚ú®', startDate: '2025-06-10', status: 'active', monthlyRevenue: [{ month: 'Jun 2025', revenue: 27834.56 }, { month: 'Jul 2025', revenue: 41267.89 }, { month: 'Aug 2025', revenue: 57923.14 }, { month: 'Sep 2025', revenue: 64378.92 }, { month: 'Oct 2025', revenue: 72156.33 }, { month: 'Nov 2025', revenue: 73892.17 }, { month: 'Dec 2025', revenue: 76234.58 }, { month: 'Jan 2026', revenue: 74891.26 }] },
                    { name: 'Isabella N.', emoji: 'üåô', startDate: '2025-04-22', lastActive: '2025-12-01', status: 'inactive', monthlyRevenue: [{ month: 'Apr 2025', revenue: 17623.45 }, { month: 'May 2025', revenue: 34891.72 }, { month: 'Jun 2025', revenue: 47234.18 }, { month: 'Jul 2025', revenue: 51678.93 }, { month: 'Aug 2025', revenue: 44523.67 }, { month: 'Sep 2025', revenue: 38912.34 }, { month: 'Oct 2025', revenue: 27456.81 }, { month: 'Nov 2025', revenue: 14789.23 }] }
                ]
            },
            'JAMES456': {
                name: 'James K.',
                joinDate: '2025-05-15',
                models: [
                    { name: 'Luna S.', emoji: 'üåü', startDate: '2025-10-01', status: 'active', monthlyRevenue: [{ month: 'Oct 2025', revenue: 51823.47 }, { month: 'Nov 2025', revenue: 67945.82 }, { month: 'Dec 2025', revenue: 73612.39 }, { month: 'Jan 2026', revenue: 79234.56 }] },
                    { name: 'Zoe W.', emoji: 'üî•', startDate: '2025-08-15', status: 'active', monthlyRevenue: [{ month: 'Aug 2025', revenue: 37891.23 }, { month: 'Sep 2025', revenue: 48567.81 }, { month: 'Oct 2025', revenue: 54234.67 }, { month: 'Nov 2025', revenue: 61478.92 }, { month: 'Dec 2025', revenue: 63912.45 }, { month: 'Jan 2026', revenue: 64523.18 }] },
                    { name: 'Chloe P.', emoji: 'üíï', startDate: '2025-07-01', status: 'active', monthlyRevenue: [{ month: 'Jul 2025', revenue: 27456.34 }, { month: 'Aug 2025', revenue: 38923.67 }, { month: 'Sep 2025', revenue: 44789.12 }, { month: 'Oct 2025', revenue: 49234.58 }, { month: 'Nov 2025', revenue: 52167.83 }, { month: 'Dec 2025', revenue: 53891.24 }, { month: 'Jan 2026', revenue: 55123.47 }] },
                    { name: 'Lily R.', emoji: 'üå∑', startDate: '2025-05-20', lastActive: '2025-11-15', status: 'inactive', monthlyRevenue: [{ month: 'May 2025', revenue: 21567.89 }, { month: 'Jun 2025', revenue: 34123.45 }, { month: 'Jul 2025', revenue: 41892.67 }, { month: 'Aug 2025', revenue: 37456.12 }, { month: 'Sep 2025', revenue: 31234.78 }, { month: 'Oct 2025', revenue: 24891.34 }, { month: 'Nov 2025', revenue: 11678.92 }] }
                ]
            },
            'ALEX789': {
                name: 'Alex R.',
                joinDate: '2025-11-01',
                models: [
                    { name: 'Grace H.', emoji: 'üåº', startDate: '2025-12-01', status: 'active', monthlyRevenue: [{ month: 'Dec 2025', revenue: 34567.89 }, { month: 'Jan 2026', revenue: 43218.76 }] },
                    { name: 'Ruby J.', emoji: 'üíé', startDate: '2025-11-10', status: 'active', monthlyRevenue: [{ month: 'Nov 2025', revenue: 27934.56 }, { month: 'Dec 2025', revenue: 35612.83 }, { month: 'Jan 2026', revenue: 38947.21 }] }
                ]
            }
        };

        let referrerData = DEMO_DATA;

        // ============================================
        // GOOGLE SHEETS DATA LOADING
        // ============================================
        async function loadFromGoogleSheets() {
            try {
                const [referrersRes, modelsRes] = await Promise.all([
                    fetch(SHEETS_CONFIG.referrersUrl),
                    fetch(SHEETS_CONFIG.modelsUrl)
                ]);

                const referrersCsv = await referrersRes.text();
                const modelsCsv = await modelsRes.text();

                const referrers = parseCSV(referrersCsv);
                const models = parseCSV(modelsCsv);

                // Build referrerData from sheets
                const data = {};
                referrers.forEach(r => {
                    if (r.code) {
                        data[r.code.toUpperCase()] = {
                            name: r.name,
                            joinDate: r.joinDate,
                            models: []
                        };
                    }
                });

                models.forEach(m => {
                    const code = m.referrerCode?.toUpperCase();
                    if (code && data[code]) {
                        data[code].models.push({
                            name: m.modelName,
                            emoji: m.emoji || '‚ú®',
                            startDate: m.startDate,
                            status: m.status || 'active',
                            lastActive: m.lastActive || null,
                            monthlyRevenue: parseMonthlyRevenue(m.monthlyRevenue)
                        });
                    }
                });

                return data;
            } catch (error) {
                console.error('Error loading Google Sheets:', error);
                return null;
            }
        }

        function parseCSV(csv) {
            const lines = csv.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            return lines.slice(1).map(line => {
                const values = line.split(',');
                const obj = {};
                headers.forEach((h, i) => obj[h] = values[i]?.trim() || '');
                return obj;
            });
        }

        function parseMonthlyRevenue(str) {
            if (!str) return [];
            return str.split(',').map(item => {
                const [month, revenue] = item.split(':');
                return { month: month.trim(), revenue: parseFloat(revenue) || 0 };
            });
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        async function init() {
            if (SHEETS_CONFIG.useGoogleSheets) {
                const sheetsData = await loadFromGoogleSheets();
                if (sheetsData) {
                    referrerData = sheetsData;
                } else {
                    console.warn('Failed to load Google Sheets, using demo data');
                }
            }

            // Check URL for code parameter
            const params = new URLSearchParams(window.location.search);
            const urlCode = params.get('code');
            if (urlCode && referrerData[urlCode.toUpperCase()]) {
                showDashboard(urlCode.toUpperCase());
            }
        }

        init();

        function checkAccess() {
            const code = document.getElementById('accessCode').value.toUpperCase().trim();
            if (referrerData[code]) {
                window.history.pushState({}, '', `?code=${code}`);
                showDashboard(code);
            } else {
                document.getElementById('accessError').style.display = 'block';
                document.getElementById('accessCode').style.borderColor = '#ef4444';
            }
        }

        document.getElementById('accessCode').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') checkAccess();
        });

        function showDashboard(code) {
            document.getElementById('accessGate').style.display = 'none';
            document.getElementById('dashboard').classList.add('active');
            loadReferrerData(code);
        }

        function getTier(monthlyRevenue) {
            if (monthlyRevenue >= 2000000) return { name: 'Diamond', rate: 3 };
            if (monthlyRevenue >= 500000) return { name: 'Gold', rate: 2.75 };
            return { name: 'Base', rate: 2.5 };
        }

        // Build a map of month -> total revenue across ALL models
        function buildMonthlyTotals(models) {
            const monthTotals = {};
            models.forEach(model => {
                model.monthlyRevenue.forEach(m => {
                    if (!monthTotals[m.month]) monthTotals[m.month] = 0;
                    monthTotals[m.month] += m.revenue;
                });
            });
            return monthTotals;
        }

        function formatCurrency(amount, abbreviated = false) {
            if (abbreviated) {
                if (amount >= 1000000) return '$' + (amount / 1000000).toFixed(2) + 'M';
                if (amount >= 1000) return '$' + Math.round(amount / 1000) + 'K';
                return '$' + amount.toLocaleString();
            }
            return '$' + amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function getMonthsSince(dateStr) {
            const start = new Date(dateStr);
            const now = new Date();
            return Math.floor((now - start) / (1000 * 60 * 60 * 24 * 30));
        }

        function getMonthsActive(model) {
            return model.monthlyRevenue.length;
        }

        function calculateModelEarnings(model, monthTotals) {
            let totalEarnings = 0;
            model.monthlyRevenue.forEach((m, index) => {
                let rate;
                if (index < 3) {
                    rate = 5; // First 3 months = 5%
                } else {
                    // After month 3, use the tier based on that month's total revenue
                    const monthTotal = monthTotals[m.month] || 0;
                    rate = getTier(monthTotal).rate;
                }
                totalEarnings += m.revenue * (rate / 100);
            });
            return totalEarnings;
        }

        function getTotalRevenue(model) {
            return model.monthlyRevenue.reduce((sum, m) => sum + m.revenue, 0);
        }

        function getCurrentMonthRevenue(model) {
            if (model.monthlyRevenue.length === 0) return 0;
            return model.monthlyRevenue[model.monthlyRevenue.length - 1].revenue;
        }

        function loadReferrerData(code) {
            const data = referrerData[code];
            if (!data) return;

            // Profile
            document.getElementById('profileName').textContent = data.name;
            document.getElementById('profileInitial').textContent = data.name.charAt(0);

            // Join date
            const joinDate = new Date(data.joinDate);
            const joinMonth = joinDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            document.getElementById('profileJoined').textContent = `Partner since ${joinMonth}`;

            // Build monthly totals across ALL models for tier calculations
            const monthTotals = buildMonthlyTotals(data.models);

            // Separate active/inactive
            const activeModels = data.models.filter(m => m.status === 'active');
            const inactiveModels = data.models.filter(m => m.status === 'inactive');

            // Calculate totals
            const currentMonthRevenue = activeModels.reduce((sum, m) => sum + getCurrentMonthRevenue(m), 0);
            const totalRevenue = data.models.reduce((sum, m) => sum + getTotalRevenue(m), 0);

            // Calculate current tier based on this month's total revenue
            const currentTier = getTier(currentMonthRevenue);

            // Update tier badge
            const tierBadge = document.getElementById('profileTierBadge');
            tierBadge.className = 'profile-tier-badge tier-' + currentTier.name.toLowerCase();
            const tierIcon = currentTier.name === 'Diamond' ? 'üíé' : currentTier.name === 'Gold' ? '‚≠ê' : 'ü•â';
            tierBadge.textContent = `${tierIcon} ${currentTier.name} ¬∑ ${currentTier.rate}%`;

            // Tier progress
            const tierProgressDiv = document.getElementById('tierProgress');
            if (currentTier.name === 'Diamond') {
                tierProgressDiv.style.display = 'none';
            } else {
                tierProgressDiv.style.display = 'block';
                const nextTier = currentTier.name === 'Base' ? { name: 'Gold', threshold: 500000 } : { name: 'Diamond', threshold: 2000000 };
                const progress = Math.min(100, (currentMonthRevenue / nextTier.threshold) * 100);
                document.getElementById('tierProgressText').textContent = `${formatCurrency(currentMonthRevenue, true)} / ${formatCurrency(nextTier.threshold, true)} monthly`;
                document.getElementById('tierProgressFill').style.width = progress + '%';
                document.getElementById('tierProgressFill').className = 'tier-progress-fill progress-to-' + nextTier.name.toLowerCase();
                document.querySelector('.tier-progress-label').textContent = `Progress to ${nextTier.name} Tier`;
            }

            // Calculate average retention (months active per model)
            const totalMonths = data.models.reduce((sum, m) => sum + m.monthlyRevenue.length, 0);
            const avgRetention = data.models.length > 0 ? Math.round(totalMonths / data.models.length) : 0;

            // Calculate this month's earnings
            let thisMonthEarnings = 0;
            activeModels.forEach(model => {
                const monthIndex = model.monthlyRevenue.length - 1;
                const currentRev = getCurrentMonthRevenue(model);
                let rate;
                if (monthIndex < 3) {
                    rate = 5;
                } else {
                    const lastMonth = model.monthlyRevenue[monthIndex].month;
                    rate = getTier(monthTotals[lastMonth]).rate;
                }
                thisMonthEarnings += currentRev * (rate / 100);
            });

            // Calculate total earnings using dynamic tier per month
            let totalEarnings = 0;
            data.models.forEach(model => {
                totalEarnings += calculateModelEarnings(model, monthTotals);
            });

            // Update stats
            document.getElementById('statActiveModels').textContent = activeModels.length;
            document.getElementById('statInactiveModels').textContent = inactiveModels.length;
            document.getElementById('statAvgRetention').textContent = avgRetention + ' mo';
            document.getElementById('statMonthlyRevenue').textContent = formatCurrency(currentMonthRevenue);
            document.getElementById('statMonthlyEarnings').textContent = formatCurrency(thisMonthEarnings);
            document.getElementById('statTotalEarnings').textContent = formatCurrency(totalEarnings);

            // Render active models
            const activeBody = document.getElementById('activeModelsBody');
            activeBody.innerHTML = '';
            document.getElementById('activeCount').textContent = activeModels.length + ' models';

            let activeTotalRev = 0;
            let activeTotalEarn = 0;

            activeModels.forEach((model, idx) => {
                const monthsActive = getMonthsSince(model.startDate);
                const isNew = model.monthlyRevenue.length < 3;
                const totalRev = getTotalRevenue(model);
                const currentRev = getCurrentMonthRevenue(model);
                const modelEarnings = calculateModelEarnings(model, monthTotals);

                // Get current rate for this model
                const modelMonths = model.monthlyRevenue.length;
                let currentRate;
                if (modelMonths <= 3) {
                    currentRate = '5%';
                } else {
                    const lastMonth = model.monthlyRevenue[modelMonths - 1].month;
                    currentRate = getTier(monthTotals[lastMonth]).rate + '%';
                }

                activeTotalRev += totalRev;
                activeTotalEarn += modelEarnings;

                const row = document.createElement('div');
                row.className = 'model-row';
                row.innerHTML = `
                    <div class="model-row-main" onclick="toggleRow(this)">
                        <div class="model-info">
                            <div class="model-avatar">${model.emoji}</div>
                            <div>
                                <div class="model-name">${model.name} <span class="expand-icon">‚ñº</span></div>
                                <div class="model-status ${isNew ? 'status-new' : 'status-active'}">${isNew ? '5% Intro Rate' : 'Active'}</div>
                            </div>
                        </div>
                        <div class="model-cell date">${formatDate(model.startDate)}</div>
                        <div class="model-cell revenue">${formatCurrency(currentRev)}</div>
                        <div class="model-cell">${formatCurrency(totalRev)}</div>
                        <div class="model-cell">${currentRate}</div>
                        <div class="model-cell earnings">${formatCurrency(modelEarnings)}</div>
                    </div>
                    <div class="monthly-breakdown">
                        <div class="breakdown-title">Monthly Revenue Breakdown</div>
                        <div class="breakdown-grid">
                            ${model.monthlyRevenue.map((m, i) => {
                                let rateLabel, rate;
                                if (i < 3) {
                                    rate = 5;
                                    rateLabel = '(5%)';
                                } else {
                                    const monthTotal = monthTotals[m.month] || 0;
                                    const tier = getTier(monthTotal);
                                    rate = tier.rate;
                                    rateLabel = `(${tier.name} ${tier.rate}%)`;
                                }
                                const earning = m.revenue * (rate / 100);
                                return `
                                    <div class="breakdown-item">
                                        <div class="breakdown-month">${m.month} ${rateLabel}</div>
                                        <div class="breakdown-values">
                                            <span class="breakdown-revenue">${formatCurrency(m.revenue)}</span>
                                            <span class="breakdown-earning">+${formatCurrency(earning)}</span>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
                activeBody.appendChild(row);
            });


            // Render inactive models
            if (inactiveModels.length > 0) {
                document.getElementById('inactiveSection').style.display = 'block';
                const inactiveBody = document.getElementById('inactiveModelsBody');
                inactiveBody.innerHTML = '';
                document.getElementById('inactiveCount').textContent = inactiveModels.length + ' models';

                inactiveModels.forEach(model => {
                    const totalRev = getTotalRevenue(model);
                    const modelEarnings = calculateModelEarnings(model, monthTotals);
                    const monthsActive = getMonthsActive(model);

                    const row = document.createElement('div');
                    row.className = 'model-row';
                    row.innerHTML = `
                        <div class="model-row-main" onclick="toggleRow(this)">
                            <div class="model-info">
                                <div class="model-avatar" style="opacity: 0.5;">${model.emoji}</div>
                                <div>
                                    <div class="model-name" style="color: #9ca3af;">${model.name} <span class="expand-icon">‚ñº</span></div>
                                    <div class="model-status status-inactive">Churned</div>
                                </div>
                            </div>
                            <div class="model-cell date">${formatDate(model.startDate)}</div>
                            <div class="model-cell date">${formatDate(model.lastActive)}</div>
                            <div class="model-cell" style="color: #9ca3af;">${formatCurrency(totalRev)}</div>
                            <div class="model-cell" style="color: #9ca3af;">${monthsActive} mo</div>
                            <div class="model-cell" style="color: #9ca3af;">${formatCurrency(modelEarnings)}</div>
                        </div>
                        <div class="monthly-breakdown">
                            <div class="breakdown-title">Monthly Revenue History</div>
                            <div class="breakdown-grid">
                                ${model.monthlyRevenue.map((m, i) => {
                                    let rateLabel, rate;
                                    if (i < 3) {
                                        rate = 5;
                                        rateLabel = '(5%)';
                                    } else {
                                        const monthTotal = monthTotals[m.month] || 0;
                                        const tier = getTier(monthTotal);
                                        rate = tier.rate;
                                        rateLabel = `(${tier.name} ${tier.rate}%)`;
                                    }
                                    const earning = m.revenue * (rate / 100);
                                    return `
                                        <div class="breakdown-item" style="opacity: 0.7;">
                                            <div class="breakdown-month">${m.month} ${rateLabel}</div>
                                            <div class="breakdown-values">
                                                <span class="breakdown-revenue">${formatCurrency(m.revenue)}</span>
                                                <span class="breakdown-earning">+${formatCurrency(earning)}</span>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                    inactiveBody.appendChild(row);
                });
            }
        }

        function toggleRow(element) {
            element.parentElement.classList.toggle('expanded');
        }
    </script>
</body>
</html>
